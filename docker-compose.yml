version: '3.8'

services:
  terminal:
    build: ./container
    container_name: landing-terminal
    restart: unless-stopped
    # Network isolation - custom bridge with no external access
    networks:
      - isolated
    # Resource limits
    mem_limit: 256m
    cpus: 0.5
    # Read-only root filesystem (except /tmp and /home)
    read_only: true
    tmpfs:
      - /tmp:size=10M
      - /home/guestuser:size=50M,uid=1000,gid=1000
    # Security options
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETUID
      - SETGID
    # Expose port only to localhost
    ports:
      - "127.0.0.1:7681:7681"

  webtop:
    image: lscr.io/linuxserver/webtop:ubuntu-mate
    container_name: darkstar-webtop
    restart: unless-stopped
    # Start on isolated network (no internet by default)
    # Use Network Control API to enable internet access
    networks:
      - isolated
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/New_York
      - SUBFOLDER=/
      - TITLE=Dark Star Desktop
      - CUSTOM_USER=darkstar
      # No password by default - accessible to anyone on the portal
      # Security through network isolation and optional password-protected internet
    volumes:
      - ./webtop-config:/config
    # Ports for Apache proxy (localhost only)
    ports:
      - "127.0.0.1:3000:3000"
      - "127.0.0.1:3001:3001"
    shm_size: "2gb"
    security_opt:
      - seccomp:unconfined  # Required for desktop environment to work properly
    # Resource limits - maximized for super-sized droplet
    mem_limit: 4g
    cpus: 3.5

networks:
  isolated:
    driver: bridge
    # Isolated network - blocks internet via iptables (firewall does the blocking)
    # internal: false allows port publishing to host for Apache proxy
    internal: false
    driver_opts:
      com.docker.network.bridge.name: isolated0

  # Network with internet access - webtop will be connected to this via password-protected API
  internet:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.name: internet0
