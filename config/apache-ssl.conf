<IfModule mod_ssl.c>
<VirtualHost *:443>
    ServerName oops.skyfort.group
    ServerAlias www.oops.skyfort.group
    ServerAdmin webmaster@localhost
    DocumentRoot /var/www/darkstar-portal

    <Directory /var/www/darkstar-portal>
        Options Indexes FollowSymLinks
        AllowOverride None
        Require all granted
    </Directory>

    # Proxy configuration
    ProxyRequests Off
    ProxyPreserveHost On
    ProxyTimeout 3600

    # Enable rewrite and set headers
    RewriteEngine On

    # Headers for WebCodecs API (required for Webtop 2.0+) - set for all webtop paths
    <LocationMatch "^/webtop">
        Header always set Cross-Origin-Opener-Policy "same-origin"
        Header always set Cross-Origin-Embedder-Policy "require-corp"
    </LocationMatch>

    # Webtop Desktop - Combined WebSocket/HTTP proxy
    # Use HTTPS port 3001 since we're serving through HTTPS
    RewriteCond %{HTTP:Connection} Upgrade [NC]
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{REQUEST_URI} ^/webtop
    RewriteRule /webtop/(.*) wss://127.0.0.1:3001/$1 [P,L]

    SSLProxyEngine on
    SSLProxyVerify none
    SSLProxyCheckPeerCN off
    SSLProxyCheckPeerName off

    ProxyPass /webtop/ https://127.0.0.1:3001/ retry=0 timeout=3600 keepalive=On
    ProxyPassReverse /webtop/ https://127.0.0.1:3001/

    # Terminal - Combined WebSocket/HTTP proxy
    RewriteCond %{HTTP:Connection} Upgrade [NC]
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{REQUEST_URI} ^/terminal
    RewriteRule /terminal/(.*) ws://127.0.0.1:7681/$1 [P,L]

    ProxyPass /terminal/ http://127.0.0.1:7681/ retry=0 timeout=3600 keepalive=On
    ProxyPassReverse /terminal/ http://127.0.0.1:7681/

    ErrorLog ${APACHE_LOG_DIR}/terminal-portal-error.log
    CustomLog ${APACHE_LOG_DIR}/terminal-portal-access.log combined

SSLCertificateFile /etc/letsencrypt/live/oops.skyfort.group/fullchain.pem
SSLCertificateKeyFile /etc/letsencrypt/live/oops.skyfort.group/privkey.pem
Include /etc/letsencrypt/options-ssl-apache.conf
</VirtualHost>
</IfModule>
