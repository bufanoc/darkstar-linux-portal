<IfModule mod_ssl.c>
<VirtualHost *:443>
    ServerName DOMAIN_PLACEHOLDER
    ServerAlias www.DOMAIN_PLACEHOLDER
    ServerAdmin webmaster@localhost
    DocumentRoot /var/www/darkstar-portal

    <Directory /var/www/darkstar-portal>
        Options Indexes FollowSymLinks
        AllowOverride None
        Require all granted
    </Directory>

    # Proxy configuration
    ProxyRequests Off
    ProxyPreserveHost On
    ProxyTimeout 3600

    # Enable rewrite
    RewriteEngine On

    # Webtop Desktop - Combined WebSocket/HTTP proxy
    # Webtop serves HTTPS internally (self-signed), we proxy to it
    RewriteCond %{HTTP:Connection} Upgrade [NC]
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{REQUEST_URI} ^/webtop
    RewriteRule /webtop/(.*) wss://127.0.0.1:3001/$1 [P,L]

    # SSL Proxy settings for webtop's self-signed certificate
    SSLProxyEngine on
    SSLProxyVerify none
    SSLProxyCheckPeerCN off
    SSLProxyCheckPeerName off

    ProxyPass /webtop/ https://127.0.0.1:3001/ retry=0 timeout=3600 keepalive=On
    ProxyPassReverse /webtop/ https://127.0.0.1:3001/

    # Terminal - Combined WebSocket/HTTP proxy (plain HTTP)
    RewriteCond %{HTTP:Connection} Upgrade [NC]
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{REQUEST_URI} ^/terminal
    RewriteRule /terminal/(.*) ws://127.0.0.1:7681/$1 [P,L]

    ProxyPass /terminal/ http://127.0.0.1:7681/ retry=0 timeout=3600 keepalive=On
    ProxyPassReverse /terminal/ http://127.0.0.1:7681/

    ErrorLog ${APACHE_LOG_DIR}/terminal-portal-error.log
    CustomLog ${APACHE_LOG_DIR}/terminal-portal-access.log combined

    # SSL Configuration - Let's Encrypt
    SSLCertificateFile /etc/letsencrypt/live/DOMAIN_PLACEHOLDER/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/DOMAIN_PLACEHOLDER/privkey.pem
    Include /etc/letsencrypt/options-ssl-apache.conf
</VirtualHost>
</IfModule>

# Redirect HTTP to HTTPS
<VirtualHost *:80>
    ServerName DOMAIN_PLACEHOLDER
    ServerAlias www.DOMAIN_PLACEHOLDER

    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
</VirtualHost>
